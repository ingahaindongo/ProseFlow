<UserControl
    x:Class="ProseFlow.UI.Views.Actions.ActionsView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:collections="using:Avalonia.Collections"
    xmlns:b="using:ProseFlow.UI.Behaviors"
    xmlns:core="using:ProseFlow.Core.Models"
    xmlns:c="using:ProseFlow.UI.Converters"
    xmlns:shadui="clr-namespace:ShadUI;assembly=ShadUI"
    xmlns:vm="using:ProseFlow.UI.ViewModels.Actions"
    xmlns:icons="clr-namespace:ProseFlow.UI.Controls.Icons"
    x:DataType="vm:ActionsViewModel">

    <UserControl.Resources>
        <c:BoolToOutputTargetConverter x:Key="BoolToOutputTargetConverter" />
        <c:StringToIconConverter x:Key="StringToIconConverter" />

        <!-- Group Header -->
        <ControlTheme x:Key="ActionGroupHeaderTheme" TargetType="DataGridRowGroupHeader">
            <Setter Property="MinHeight" Value="48" />
            <Setter Property="Background" Value="{DynamicResource CardBackgroundColor}" />
            <Setter Property="Template">
                <ControlTemplate x:DataType="collections:DataGridCollectionViewGroup">
                    <Border Background="{TemplateBinding Background}" BorderBrush="{DynamicResource BorderColor}"
                            BorderThickness="0,0,0,1">
                        <DataGridFrozenGrid Name="PART_Root" ColumnDefinitions="Auto,Auto,*"
                                            MinHeight="{TemplateBinding MinHeight}">
                            <!-- Indent Spacer -->
                            <Rectangle Name="PART_IndentSpacer" Grid.Column="0" />

                            <!-- Expander Button -->
                            <ToggleButton Name="PART_ExpanderButton" Grid.Column="1"
                                          Theme="{StaticResource DataGridRowGroupExpanderButtonTheme}"
                                          Margin="12,0,0,0" VerticalAlignment="Center" />

                            <!-- Group Content: Name, Count, and Actions Dropdown -->
                            <Grid Grid.Column="2" Margin="12,0" VerticalAlignment="Center" Cursor="SizeAll"
                                  ColumnDefinitions="*,Auto">

                                <!-- Group Name and Item Count (aligned left) -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8"
                                            VerticalAlignment="Center">
                                    <TextBlock FontWeight="Medium" Text="{Binding Key}" />
                                    <TextBlock Classes="Muted" Text="{Binding ItemCount, StringFormat=({0})}" />
                                </StackPanel>

                                <!-- Group Actions Dropdown -->
                                <shadui:SimpleDropdown Grid.Column="1" Classes="Ghost"
                                                       PopupPlacement="BottomEdgeAlignedRight" PopupWidth="150"
                                                       Cursor="Arrow">
                                    <shadui:SimpleDropdown.TriggerContent>
                                        <icons:SymbolIcon Size="16" Symbol="Command" />
                                    </shadui:SimpleDropdown.TriggerContent>
                                    <Button
                                        Command="{Binding $parent[UserControl].((vm:ActionsViewModel)DataContext).EditGroupCommand, FallbackValue={x:Null}}"
                                        CommandParameter="{Binding Key}">
                                        <shadui:ButtonAssist.Icon>
                                            <icons:SymbolIcon Size="18" Symbol="Pen" />
                                        </shadui:ButtonAssist.Icon>
                                        Rename
                                    </Button>
                                    <Separator />
                                    <Button Classes="Destructive"
                                            Command="{Binding $parent[UserControl].((vm:ActionsViewModel)DataContext).DeleteGroupCommand, FallbackValue={x:Null}}"
                                            CommandParameter="{Binding Key}">
                                        <shadui:ButtonAssist.Icon>
                                            <icons:SymbolIcon Size="18" Symbol="Trash2" />
                                        </shadui:ButtonAssist.Icon>
                                        Delete
                                    </Button>
                                </shadui:SimpleDropdown>
                            </Grid>
                        </DataGridFrozenGrid>
                    </Border>
                </ControlTemplate>
            </Setter>
        </ControlTheme>
    </UserControl.Resources>

    <DockPanel LastChildFill="True">
        <!-- Page Header -->
        <StackPanel Margin="48,24" DockPanel.Dock="Top" Spacing="4">
            <TextBlock Classes="h2" Text="Manage Actions" />
            <TextBlock Classes="p" Text="Create, edit, and organize the AI actions that power ProseFlow."
                       TextWrapping="Wrap" />
        </StackPanel>

        <!-- Main Content -->
        <ScrollViewer>
            <StackPanel Margin="48,0,48,24" Spacing="16">
                <!-- Action Buttons -->
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Classes="Primary" Command="{Binding AddActionCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <icons:SymbolIcon Size="18" Symbol="Plus" />
                            <TextBlock Text="New Action" />
                        </StackPanel>
                    </Button>
                    <Button Classes="Primary" Command="{Binding AddGroupCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <icons:SymbolIcon Size="18" Symbol="Group" />
                            <TextBlock Text="New Group" />
                        </StackPanel>
                    </Button>
                    <Button Classes="Outline" Command="{Binding ImportActionsCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <icons:SymbolIcon Size="18" Symbol="Download" />
                            <TextBlock Text="Import from JSON" />
                        </StackPanel>
                    </Button>
                    <Button Classes="Outline" Command="{Binding ExportActionsCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <icons:SymbolIcon Size="18" Symbol="Upload" />
                            <TextBlock Text="Export to JSON" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Groups and Actions List -->
                <DataGrid
                    b:AdvancedDataGridDropBehavior.Command="{Binding ReorderCommand}"
                    ItemsSource="{Binding GroupedActions}"
                    AutoGenerateColumns="False" CanUserReorderColumns="False" CanUserResizeColumns="True"
                    CanUserSortColumns="False" GridLinesVisibility="Horizontal" IsReadOnly="True"
                    HeadersVisibility="Column"
                    RowGroupTheme="{StaticResource ActionGroupHeaderTheme}">

                    <DataGrid.Columns>
                        <!-- Drag Handle Column -->
                        <DataGridTemplateColumn Width="40">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <icons:SymbolIcon Size="18" Symbol="MoveVertical"
                                                ToolTip.Tip="Drag and drop to reorder actions." />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Name Column (with Icon) -->
                        <DataGridTemplateColumn Width="*" Header="Name">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate DataType="core:Action">
                                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                        <PathIcon Width="16" Height="16" Foreground="{x:Null}"
                                                  Data="{Binding Icon, Converter={StaticResource StringToIconConverter}}">
                                            <PathIcon.Styles>
                                                <Style Selector="Path">
                                                    <Setter Property="Stroke" Value="{DynamicResource PrimaryColor}" />
                                                    <Setter Property="StrokeThickness" Value="1" />
                                                </Style>
                                            </PathIcon.Styles>
                                        </PathIcon>
                                        <TextBlock Text="{Binding Name}" />
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Default Output Column -->
                        <DataGridTextColumn Width="150"
                                            Binding="{Binding OpenInWindow, Converter={StaticResource BoolToOutputTargetConverter}, DataType=core:Action}"
                                            Header="Default Output" />

                        <!-- Actions Column (with Dropdown) -->
                        <DataGridTemplateColumn Width="Auto" Header="Actions">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <shadui:SimpleDropdown HorizontalAlignment="Center" VerticalAlignment="Center"
                                                           Classes="Ghost" PopupPlacement="BottomEdgeAlignedLeft"
                                                           PopupWidth="150">
                                        <shadui:SimpleDropdown.TriggerContent>
                                            <icons:SymbolIcon Size="16" Symbol="Command" />
                                        </shadui:SimpleDropdown.TriggerContent>
                                        <Button
                                            Command="{Binding $parent[UserControl].((vm:ActionsViewModel)DataContext).EditActionCommand, FallbackValue={x:Null}}"
                                            CommandParameter="{Binding .}">
                                            <shadui:ButtonAssist.Icon>
                                                <icons:SymbolIcon Size="18" Symbol="Pen" />
                                            </shadui:ButtonAssist.Icon>
                                            Edit
                                        </Button>
                                        <Separator />
                                        <Button Classes="Destructive"
                                                Command="{Binding $parent[UserControl].((vm:ActionsViewModel)DataContext).DeleteActionCommand, FallbackValue={x:Null}}"
                                                CommandParameter="{Binding .}">
                                            <shadui:ButtonAssist.Icon>
                                                <icons:SymbolIcon Size="18" Symbol="Trash2" />
                                            </shadui:ButtonAssist.Icon>
                                            Delete
                                        </Button>
                                    </shadui:SimpleDropdown>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</UserControl>