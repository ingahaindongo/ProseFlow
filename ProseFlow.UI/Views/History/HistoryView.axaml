<UserControl
    x:Class="ProseFlow.UI.Views.History.HistoryView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:shadui="clr-namespace:ShadUI;assembly=ShadUI"
    xmlns:vm="using:ProseFlow.UI.ViewModels.History"
    xmlns:icons="clr-namespace:ProseFlow.UI.Controls.Icons"
    x:DataType="vm:HistoryViewModel">

    <UserControl.Styles>
        <Style Selector="shadui|Card:pointerover Expander">
            <Setter Property="IsExpanded" Value="True" />
        </Style>
    </UserControl.Styles>
    
    <DockPanel LastChildFill="True">

        <!-- Page Header -->
        <DockPanel Margin="48,24" DockPanel.Dock="Top">
            <Button
                DockPanel.Dock="Right"
                VerticalAlignment="Center"
                Classes="Destructive"
                Command="{Binding ClearHistoryCommand}">
                <shadui:ButtonAssist.Icon>
                    <icons:SymbolIcon Size="18" Symbol="Trash" />
                </shadui:ButtonAssist.Icon>
                Clear History
            </Button>

            <StackPanel Spacing="4">
                <TextBlock Classes="h2" Text="Interaction History" />
                <TextBlock
                    Classes="p"
                    Text="A log of your recent AI operations."
                    TextWrapping="Wrap" />
            </StackPanel>
        </DockPanel>

        <!-- Search and Filter Controls -->
        <Grid ColumnDefinitions="*, Auto" ColumnSpacing="8" Margin="48,0,48,24" DockPanel.Dock="Top">
            <TextBox Grid.Column="0" Watermark="Search history..." Text="{Binding SearchText, Mode=TwoWay}" Classes="Clearable" />
            <ComboBox Grid.Column="1" MinWidth="150" ItemsSource="{Binding AvailableFilters}" SelectedItem="{Binding SelectedFilter}" />
        </Grid>

        <!-- Scrollable Main Content -->
        <ScrollViewer>
            <StackPanel>
                <!-- Empty State Message -->
                <Border IsVisible="{Binding !HasHistory}">
                    <StackPanel Margin="0,80" Spacing="16" HorizontalAlignment="Center">
                        <icons:SymbolIcon Size="64" Symbol="History" HorizontalAlignment="Center" />
                        <TextBlock Classes="h4 Muted" Text="{Binding EmptyStateMessage}" HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>

                <ItemsControl Margin="48,0,48,24" ItemsSource="{Binding HistoryEntries}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <shadui:Card HasShadow="True" Margin="0,8">
                                <!-- Header and summary -->
                                <shadui:Card.Header>
                                    <DockPanel>
                                        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                            <TextBlock
                                                Classes="Small Muted"
                                                Text="{Binding Timestamp, StringFormat='{}{0:g}'}" />
                                            
                                            <Button
                                                Classes="Ghost Destructive"
                                                ToolTip.Tip="Delete this entry"
                                                Command="{Binding $parent[ItemsControl].((vm:HistoryViewModel)DataContext).DeleteHistoryEntryCommand, FallbackValue={x:Null}}"
                                                CommandParameter="{Binding}">
                                                <icons:SymbolIcon Size="16" Symbol="Trash" />
                                            </Button>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                            <TextBlock FontWeight="Medium" Text="{Binding ActionName}" />
                                            <TextBlock Classes="Muted" Text="·" />
                                            <TextBlock Classes="Small Muted" Text="{Binding ProviderUsed}" />
                                        </StackPanel>
                                    </DockPanel>
                                </shadui:Card.Header>

                                <!-- Content Expander -->
                                <Expander HorizontalAlignment="Stretch">
                                    <Expander.Header>
                                        <TextBlock Classes="Small Muted" Text="Show Details..." />
                                    </Expander.Header>

                                    <StackPanel Margin="0,12,0,0" Spacing="16">
                                        <!-- Input Section -->
                                        <StackPanel Spacing="8">
                                            <TextBlock Text="Input" FontWeight="Medium" />
                                            <Border
                                                Padding="12"
                                                Background="{DynamicResource GhostColor}"
                                                CornerRadius="{DynamicResource LgCornerRadius}">
                                                <ScrollViewer MaxHeight="150">
                                                    <SelectableTextBlock
                                                        Classes="Small"
                                                        Text="{Binding InputText}"
                                                        TextWrapping="Wrap" />
                                                </ScrollViewer>
                                            </Border>
                                        </StackPanel>

                                        <!-- Output Section -->
                                        <StackPanel Spacing="8">
                                            <TextBlock Text="Output" FontWeight="Medium" />
                                            <Border
                                                Padding="12"
                                                Background="{DynamicResource GhostColor}"
                                                CornerRadius="{DynamicResource LgCornerRadius}">
                                                <ScrollViewer MaxHeight="250">
                                                    <SelectableTextBlock
                                                        Classes="Small"
                                                        Text="{Binding OutputText}"
                                                        TextWrapping="Wrap" />
                                                </ScrollViewer>
                                            </Border>
                                        </StackPanel>
                                    </StackPanel>
                                </Expander>
                            </shadui:Card>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</UserControl>